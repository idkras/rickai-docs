#!/usr/bin/env python3
"""
–ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Rick.ai
–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
"""

import subprocess
import sys
import os
import shutil
from datetime import datetime
from pathlib import Path


def run_command(command, check=True):
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É"""
    try:
        subprocess.run(command, shell=True, check=check)
        return True
    except subprocess.CalledProcessError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return False


def copy_symlinks_to_real_files():
    """–ö–æ–ø–∏—Ä—É–µ—Ç —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è —Å–±–æ—Ä–∫–∏"""
    print("üîó –ö–æ–ø–∏—Ä—É–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã...")
    
    docs_dir = Path("docs")
    if not docs_dir.exists():
        print("‚ùå –ü–∞–ø–∫–∞ docs –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return False
    
    copied_files = []
    
    # –ò—â–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –≤ –ø–∞–ø–∫–µ docs
    for file_path in docs_dir.rglob("*"):
        if file_path.is_symlink():
            try:
                # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —É–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞
                target_path = file_path.resolve()
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ü–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if target_path.exists():
                    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ–ø–∏—é
                    temp_path = file_path.with_suffix(file_path.suffix + ".temp")
                    
                    # –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ü–µ–ª–µ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
                    shutil.copy2(target_path, temp_path)
                    
                    # –£–¥–∞–ª—è–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É
                    file_path.unlink()
                    
                    # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
                    temp_path.rename(file_path)
                    
                    copied_files.append(str(file_path))
                    print(f"‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: {file_path.name}")
                else:
                    print(f"‚ö†Ô∏è  –¶–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {target_path}")
                    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –±–∞–∑–æ–≤—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º
                    create_fallback_file(file_path)
                    copied_files.append(str(file_path))
                    print(f"‚úÖ –°–æ–∑–¥–∞–Ω fallback —Ñ–∞–π–ª: {file_path.name}")
                    
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ {file_path}: {e}")
                return False
    
    if copied_files:
        print(f"üìã –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(copied_files)}")
    else:
        print("‚ÑπÔ∏è  –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
    
    return True


def create_fallback_file(file_path):
    """–°–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª —Å –±–∞–∑–æ–≤—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –µ—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"""
    fallback_content = f"""# {file_path.stem.replace('-', ' ').title()}

## –û–±–∑–æ—Ä

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ {file_path.stem.replace('-', ' ').lower()}.

## –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ

–≠—Ç–æ—Ç —Ñ–∞–π–ª –±—ã–ª —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ, —Ç–∞–∫ –∫–∞–∫ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

---

*–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞: {datetime.now().strftime('%d %B %Y')}*
"""
    
    with open(file_path, 'w', encoding='utf-8') as f:
        f.write(fallback_content)


def main():
    """–ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π"""
    print("üöÄ –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Rick.ai")
    print("=" * 40)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    if not Path("mkdocs.yml").exists():
        print("‚ùå mkdocs.yml –Ω–µ –Ω–∞–π–¥–µ–Ω")
        sys.exit(1)
    
    # –ö–æ–ø–∏—Ä—É–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
    if not copy_symlinks_to_real_files():
        print("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫")
        sys.exit(1)
    
    # Git –æ–ø–µ—Ä–∞—Ü–∏–∏
    print("üìù Git –æ–ø–µ—Ä–∞—Ü–∏–∏...")
    run_command("git add .")
    
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    run_command(f'git commit -m "Quick update {timestamp}"')
    run_command("git push origin main")
    
    # –î–µ–ø–ª–æ–π
    print("üåê –î–µ–ø–ª–æ–∏–º –Ω–∞ GitHub Pages...")
    if not run_command("mkdocs gh-deploy --force"):
        sys.exit(1)
    
    print("‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!")
    print("üìñ https://idkras.github.io/rickai-docs/")


if __name__ == "__main__":
    main()
